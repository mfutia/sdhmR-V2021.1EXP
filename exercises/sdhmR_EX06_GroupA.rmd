---
title: "Exercise 6 Group A"
author: "Mia McReynolds, Eli Polzer, Matt Futia"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_knit$set(root.dir = "C:/Users/mttft/Desktop/UVM/UVM Courses/SDHM_R/sdhmR-V2021.1EXP")
knitr::opts_chunk$set(warning=FALSE,error=TRUE,message=FALSE)
```

---

## Question #1

* Break the predictor variables into logical groups of **topography**, **temperature**, and **precipitation**.  Do this by creating a new column called **`pred_type`** and add it the dataframe.

```{r}
# Load packages
library(tidyverse)
library(data.table)
library(modeest)

# Set working directories
path.root <- "C:/Users/mttft/Desktop/UVM/UVM Courses/SDHM_R/sdhmR-V2021.1EXP"
path.mod2 <- paste(path.root, "/data/module02", sep = "")
path.figs <- paste(path.root, "/powerpoints/figures", sep = "") 
path.gis <- paste(path.root, "/data/gis_layers", sep = "")

# Load CRSs
setwd(path.root)
source("r_code/prjs4_sdhmR.r")
ls(pattern = "prj.")

# Load presence:pseudo-absence and predictor data
load(paste(path.mod2, "/range_pres_psu_data.RData", sep = ""))
```

```{r}
all_data = range_PPsA_Data
pred_groups = data.frame(names(all_data[,27:42]))
names(pred_groups) = "Variable"
topo = c("exp1","exp3","exp5","prad","rough","topo")
temp = c("tave1","tave2","tmax1","tmax2")
precip = c("et5","et6","ets","mind","prec1","prec2")
pred_groups$pred_type = if_else(pred_groups$Variable %in% topo,"topography",
                                if_else(pred_groups$Variable %in% temp,"temperature", "precipitation"))
```

---

## Question #2

* Assess correlations:
  * Among all variables; and
  * Within each of the logical groupings created above

```{r}
cut.point <- 0.7

### Correlations among all variables
c1 <- cor(all_data[, c(27:42)], use = "pairwise.complete.obs", method = "spearman")
c1
c2 <- subset(c1 > cut.point | c1 < -cut.point)
c2

### Correlations within groupings
# Topo correlations
c3 <- cor(dplyr::select(all_data, one_of(topo)), use = "pairwise.complete.obs", method = "spearman")
c_topo <- subset(c3 > cut.point | c3 < -cut.point)
c_topo

# Temp correlations
c4 <- cor(dplyr::select(all_data, one_of(temp)), use = "pairwise.complete.obs", method = "spearman")
c_temp <- subset(c4 > cut.point | c4 < -cut.point)
c_temp

# Precip correlations
c5 <- cor(dplyr::select(all_data, one_of(precip)), use = "pairwise.complete.obs", method = "spearman")
c_precip <- subset(c5 > cut.point | c5 < -cut.point)
c_precip
```

---

## Question #3

* Examine variable importance of each predictor variable as related to presence:absence using the process described in the Module.

```{r}
### Determine VIP with GLMs
varimp.glm <- function(tr.spp, tr.var, pres, pf, pl) {
  tmp.mat <- matrix(ncol = 2, nrow = (pl - pf + 1))
  for (i in pf:pl) {
    tmp <- glm(tr.spp[, pres] ~ tr.var[, i] + I((tr.var[, i])^2), na.action = na.omit,
      family = binomial)
    tmp.mat[(i - pf + 1), 1] <- tmp$aic
    tmp.mat[(i - pf + 1), 2] <- (1 - (tmp$deviance/tmp$null.deviance))
    }
  return(tmp.mat)
} 

tr.vip <- all_data[, c(2, 27:42)]
pres <- 1
v.start <- 2
v.stop <- ncol(tr.vip)
v.num <- v.stop - 1
dev.fit <- varimp.glm(tr.vip, tr.vip, pres, v.start, v.stop)
dev.fit <- data.frame(pred_groups, dev.fit)
setnames(dev.fit, c("X1", "X2"), c("AIC", "AdjDeviance"))

dev.fit1 <- dev.fit[order(dev.fit$pred_type),]
dev.fit$Variable <- factor(dev.fit$Variable, 
                           levels = dev.fit$Variable[order(dev.fit$pred_type)])

ggplot()+
  geom_col(data = dev.fit, aes(Variable, AdjDeviance, fill = pred_type))+
  scale_y_continuous(limits = c(0,0.16), expand = c(0,0))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
        panel.background = element_blank(),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"))
```

```
From the precipitation variables, etpt_5 and mind_yr_av have similarly high adjusted deviance. Based on temperature, tmax_summe has the highest adjusted deviance. Lastly, based on topography, rough_1k has the highest adjusted deviance.
```

---

## Question #4

* Eliminate redundant variables with a goal of retaining 7-10 of the 16 available
* Justify your decision(s) to keep / remove variables using bullets

```{r}
remove = c("et6", "ets", "prec2", "tave1", "tave2", "tmax2", "exp1", "exp3", "exp5")
tr_RANG = dplyr::select(all_data, !one_of(remove))
```

```
From the precipiation variables, I elimiated etpt_6, and etpt_sprin because they are highly correlated with mind_yr_av and have lower adjusted deviance. I also eliminated prec_w_hal because of its strong correlation with prec_winte and the lower adjusted variance. Of the temperature variables, I only retained tmax_summer because it is highly correlated with the other three temperature variables and has the highest adjusted deviance. Lastly, I eliminated the topographic variables exp1nrm, exp3nrm, and exp5nrm due to their low adjusted deviance.
```

---

## Question #5

* Include the term **tr_MORT**, **tr_PERS**, **tr_RANG**, and **tr_SEED** somewhere in the final training data objects, depending on your data group.  Use of **tr_ByGroup** here means the data are now ready for model creation.
* Save your data as R objects:
  * Dataframe;
  * Point shapefile with geometry in R
  * Export as a point shapefile in ESRI format
* Save these R objects in a **`.RData`** file

These data will be used as we next begin the SDHM model constructions.

```{r}
# Convert data.frame to shapefile
tr_RANG_SF <- st_as_sf(tr_RANG, coords = c("tr.wgs_x", "tr.wgs_y"), crs = prj.wgs84, remove = F)

setwd(path.mod2)
save(tr_RANG, tr_RANG_SF, file = "tr_RANG.Rdata")
st_write(tr_RANG_SF, dsn = ".", layer = "tr_RANG_SF", driver = "ESRI Shapefile", delete_layer = T, delete_dsn = T)
```

---

## The End

---
