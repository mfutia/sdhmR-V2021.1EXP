---
title: "Exercise 11 Group A"
author: "Mia McReynolds, Eli Polzer, Matt Futia"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_knit$set(root.dir = "C:/Users/mttft/Desktop/UVM/UVM Courses/SDHM_R/sdhmR-V2021.1EXP")
knitr::opts_chunk$set(warning=FALSE,error=TRUE,message=FALSE)
```

```{r include=F}
# Load packages
library(tidyverse)
library(data.table)
library(magrittr)
library(PresenceAbsence) # PresenceAbsence for accuracy metrics
library(dismo)
library(gbm)
library(raster)
library(sf)

# Set working directories
path.root <- "C:/Users/mttft/Desktop/UVM/UVM Courses/SDHM_R/sdhmR-V2021.1EXP"
path.mod2 <- paste(path.root, "/data/module02", sep = "")
path.figs <- paste(path.root, "/powerpoints/figures", sep = "") 
path.gis <- paste(path.root, "/data/gis_layers", sep = "")
path.range <- paste(path.root, "/data/RangeData", sep = "")

# Load CRSs
setwd(path.root)
source("r_code/prjs4_sdhmR.r")
ls(pattern = "prj.")
```

---

## Question #1

* Import and explore data
  * **NOTE**:  intent is not to reduce number of variables; that was completed in exercise #5.  Rather, calculate simple descriptive statistics (mean, sd, n) and boxplots


```{r}
# load range-wide training data
load(paste(path.root, "/data/RangeData/ShortRangeData.RData", sep = ""))
str(r_dat)
```

```{r}
#pivot for ggplotting/summary 
r_dat_long <- r_dat %>% 
  pivot_longer(etpt_5.img:topos.img, names_to = "Variable", values_to = "Value") 
r_dat_long %>% group_by(Variable) %>% 
  summarise(n = n(),
            mean = mean(Value), 
            sd = sd(Value), 
            min = min(Value), 
            max = max(Value))
```

```{r}
#boxplot
ggplot(r_dat_long, aes(y=Value)) +
  geom_boxplot() +
  facet_wrap(~Variable, scales="free") +
  theme_classic()
```

---

## Question #2

* Construct a boosted regression tree (BRT) model using the presence:absence data
* Build plots of variable importance values

*Model Formulation*
```{r}
r_dat %<>% na.omit()
resp <- paste("as.factor(", colnames(r_dat[2]), ")", sep = "") # assign resp to col number
n.col <- ncol(r_dat) # number of columns(11)
pred <- 5:n.col  # assign predictors to column numbers (5:11)
```

*Build BRT Model*
```{r}
set.seed(1234) 
date() # "Wed Mar 17 22:54:10 2021"
mod1.BRT <- gbm.step(data = r_dat,
                     gbm.x = pred,          # Predictor columns
                     gbm.y = 2,             # Response column
                     family = "bernoulli",  # Bernoulli for logistic model
                     tree.complexity = 4,
                     learning.rate = 0.001,
                     bag.fraction = 0.75,   # Proportion of data used for permutations (typically 0.5-0.75)
                     n.folds = 10,          # Number of folds for cross validation
                     n.trees = 500,
                     plot.main = TRUE, 
                     keep.fold.fit = TRUE)
date() # "Wed Mar 17 23:03:34 2021"
```


---

## Question #3

* Calculate accuracy metrics (as in Module 3.2 and 3.3, Analytical Intermission) using:
  * Resubstitution approaches, and
  * A 10-fold cross--validation approach

*Investigate Model Output*
```{r}
ls(mod1.BRT)

head(mod1.BRT$fitted)  # model fit values

mod1.BRT$contributions # relative variable importance

mod1.BRT
```

*Re-substitution*
```{r}
modl <- "mod1.BRT" # add var to keep track of model
dat <- cbind(modl, r_dat[2], mod1.BRT$fitted, mod1.BRT$fold.fit) # build dataframe
names(dat)[3:4] <- c("pred", "cvpred") # rename vars
head(dat, 2)

dat$cvpred <- exp(dat$cvpred)/(1 + exp(dat$cvpred)) # convert from logit
head(dat, 2)

# determine best threshold using PresenceAbsence package
mod.cut <- optimal.thresholds(dat, opt.methods = c("ObsPrev")) # threshold=PREVALENCE
mod.cut

# generate confusion matrix
mod.cfmatR <- table(dat[[2]], factor(as.numeric(dat$pred >= mod.cut$pred)))
mod.cfmatX <- table(dat[[2]], factor(as.numeric(dat$cvpred >= mod.cut$cvpred)))
mod2.cfmatR
mod2.cfmatX

# calculate model accuracy with standard deviation=F
mod.acc <- presence.absence.accuracy(dat, threshold = mod.cut$pred, st.dev = F)
tss <- mod.acc$sensitivity + mod.acc$specificity - 1

mod.acc <- cbind(mod.acc[1:7], tss) # bind all metrics
mod.acc[c(1, 4:5, 7:8)]

# plotting AUC
  auc.roc.plot(dat2, color = T) # basic AUC plot; pkg PresenceAbsence 

```

*10-fold Cross-validation*
```{r}

```


---

## Question #4

* Build 2 prediction maps:
  * A raw probability estimate for each cell in the modelling domain; and
  * A classified map based on the selected threshold from Question #3

---

## Question #5

* Save your data as R objects:
  * Accuracy metrics as a dataframe;
  * Classification threshold as a stand--alone scalar
  * Both prediction maps as **`.img`** format
* Save these R objects in a **`.RData`** file

These data will be used again in Module 10, Ensemble Models.

---

## The End

---
