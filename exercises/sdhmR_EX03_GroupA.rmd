---
title: "Homework 3: Modelling Frame and FISHNET Construction"
author: "Eli Polzer, Matt Futia, and Amelia McReynolds"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r global_options, include=FALSE}
#Mia's directory
knitr::opts_knit$set(root.dir = "~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1")

knitr::opts_chunk$set(warning=FALSE,error=TRUE,message=FALSE)

#filepaths
  path.root <- "~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1" 
  path.mod2 <- paste(path.root, "/data/module02", sep = "")
  path.figs <- paste(path.root, "/powerpoints/figures", sep = "") 
  path.gis <- paste(path.root, "/data/gis_layers", sep = "")
```

```{r}
# some libraries
  library(raster)	# FXNS: extent, raster, res, rasterize, values, writeRaster, 
					#       cellFromXY, extract
  library(sf)    	# FXNS: st_as_sf, st_as_sfc, st_bbox, st_convex_hull, st_union
					#       st_buffer, st_read, st_write, st_intersection, st_geometry,
					#       st_drop_geometry, st_coordinates, st_sf
  library(terra)	# FXNS: as.data.frame, rast, vect
  library(readr)
  library(ggplot2)
  library(dplyr)
  library(tidyr)
```


---

## This exercise links to Module 2.3.4

Submit the completed exercise to us at:

* t.edwards@usu.edu 
* eric_tsakiris@fws.gov 

---

## Context

The Uinta Basin hookless cactus (*Sclerocactus wetlandicus*) (SCWE) is listed as a threatened species.  Recovery goals require:
* An accurate range map;
* Comprehensive surveys on locations; and
* Other needs as well
[FWS ECOS](https://ecos.fws.gov/ecp/species/9037) has an expert opinion-based "blob" of an hypothetical SCWE modelling (ie, the "blob") domain.

## The Data

* Acquire from the ECOS site the SCWE "blob" shapefile (call it: scwe_ecospoly) 
* Import the **`scwe_pres.csv`** file of known SCWE presence points
* Data in: **`~\sdhmR-V2020.2\data\gis_layers`** and **`...\module02`**, respectively

---

## Question #1

* Import the ECOS--acquired SCWE "blob" as a spatial object (call it: **`scwe_ecospoly`**)
* Find and acquire the **`CRS epsg:42303`** and it's **`proj4string`** â€“ this is the CRS for ALL subsequent analyses
* Set CRS of (i) the ECOS "blob" and (ii) the imported points to epsg:42303
* Plot the presence points relative to the ECOS-based polygon "blob"

```{r}
#import ECOS blob shapefile w/ sf package
scwe_ecospoly <- st_read("~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1/data/gis_layers/scwe_ecospoly.shp")

#import presence points data w/ readr
scwe_pres <- read_csv("~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1/data/module02/scwe_pres.csv", 
     col_types = cols(date.r = col_date(format = "%Y-%m-%d")))
```

```{r}
#proj4string for epsg:42303 from https://epsg.io/42303 
prj.epsg42303 <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs no_defs"

#proj4string for the scwe_pres current CRS:  ALBERS NORTH AMERICA NAD83
#   https://epsg.io/5070
    prj.aeaN83 <- "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs" # epsg:42303 


#set CRS of the ECOS "blob" to epsg:42303 -- convert from the current crs
  scwe_ecospoly_01 <- st_transform(scwe_ecospoly, crs = prj.epsg42303) # output pts as spatial
  st_crs(scwe_ecospoly_01)$proj4string # check crs 

#set CRS of the imported points to epsg:42303 - similar to CSV in m02.01-dataimport
pts.in <- st_as_sf(scwe_pres, coords = c("aeaN83_x", "aeaN83_x"), 
    crs = prj.aeaN83, remove = F) # remove=F to retain input x,y
  st_crs(pts.in)$proj4string # check crs

  # transform to new crs -- convert from the current crs
  scwe_pres_01 <- st_transform(pts.in, crs = prj.epsg42303) # output pts as spatial
  st_crs(scwe_pres_01)$proj4string # check crs -looks good

  # adding new geometry back into dataframe as columns
  coords <- data.frame(st_coordinates(scwe_pres_01)) # create df of new geometry
  names(coords) <- c("NAD83_x", "NAD83_y") # assign names
  scwe_pres_01 <- st_sf(data.frame(scwe_pres_01,coords)) # add columns

```

```{r}
# Plot the presence points relative to the ECOS-based polygon "blob"
par(mfrow = c(1, 1))
  plot(st_geometry(scwe_ecospoly_01), axes = T, col = "grey70") # simple plot
# add presence points
  points(scwe_pres_01$NAD83_x, scwe_pres_01$NAD83_y, pch=20, col="darkgreen", add=T)
```

---

## Question #2

* Generate a buffered point-based (ie OPTION #4 from Mod 2.3.4) modelling frame
* Set buffer of 10,000 m
* Set CRS of modelling frame to epsg:42303

---

## Question #3

* Select larger of the two frames as FISHNET extent 
  * (HINT: examine extents of both -- one will be larger)

---

## Question #4

* Build a 1,000 m (1 km) square FISHNET
* Save both spatial and dataframe FISHNETs as R objects 
  * (NOTE: we will use these later so be sure and save !!!)
* Export as both dataframe (ie, no geometry) and ESRI shapefile

---

## Question #5

Once you have completed the analyses above, answer the following:

* How do the known SCWE presences relate to the modelling frame "blob"?
* How different is the SCWE "blob" from a buffered point-based modelling domain?
* What is the best "blob" for creating a data indexing FISHNET?  Why?

---

## The End

---
