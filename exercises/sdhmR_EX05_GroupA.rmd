---
title: "Exercise 5: Building the Training Dataframe"
author: "Group A: Eli Polzer, Matt Futia, Mia McReynolds"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r global_options, include=FALSE}
knitr::opts_knit$set(root.dir = "~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1")
knitr::opts_chunk$set(warning=FALSE,error=TRUE,message=FALSE)
```

```{r}
# some pathnames; yours will be specific to your CPU !!
  path.root <- "~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1" 
  
# below is the recommended class root dir
  #path.root <- "~/sdhmR-V2021.1"  # typical class root dir
  path.mod2 <- paste(path.root, "/data/module02", sep = "")
  path.figs <- paste(path.root, "/powerpoints/figures", sep = "") 
  path.gis <- paste(path.root, "/data/gis_layers", sep = "")

# some libraries
  library(raster)	# FXNS:	raster, projection, projectRaster, extract, crop
  # library(readr)
  library(ggplot2)
  # library(dplyr)
   library(sf)    
  
  #add proj string for WGS 84
prj.wgs84 <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs" # epsg:4326
```


```{r}
#load presence/absence data 
  pres.abs <- get(load("~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1/data/module02/pied.PPsA_range.RData")) 
  head(pres.abs, 2) 
```
  

---

## Question #1

* Import the predictor GIS variables into R

```{r}
# Import predictor GIS variables
setwd(path.root)

rastlist <- list.files(path = "data/exercise/preds", pattern='.img$', 
all.files=TRUE, full.names=FALSE)

# buffer = rang.bufR

setwd("~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1/data/exercise/preds")
layers <- {}
for (i in 1:length(rastlist)) {
  r1 <- raster(rastlist[i])
  names(r1) <- strsplit(rastlist[i], "_wgs.img")
  layers <- c(layers, r1)
}
layers
```


```{r, message=FALSE, eval=FALSE}
#run this entire chunk at one time!!

 setwd("~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1/data/exercise/preds")

# img.list <- list.files(pattern = ".img$") # list of .img files; $ strips extra
# img.list # examine

# # loop for extracting topo data w/raster stack
#   layers <- {} # initialize (empty) list of raster layers
#   for (i in 1:length(img.list)) {
#     r1 <- crop(raster(img.list[i]), rang.bufR) # crop pred var raster to buffer raster --> can skip this
#     r1 <- raster(img.list[i])
#     names(r1) <- strsplit(img.list[i], ".img") # assign name to raster - not working
#    layers <- c(layers, r1) # add raster to layer of rasters
#   }
#   layers # examine raster stack; return is a list of raster layers

# Individual import:
etpt5 <- raster("etpt_5.img")
etpt6 <- raster("etpt_6.img")
etptsprin <- raster("etpt_sprin.img") 
exp1nrm <- raster("exp1nrm.img") 
exp3nrm <- raster("exp3nrm.img") 
exp5nrm <- raster("exp5nrm.img")
mindyrav <- raster("mind_yr_av.img")
pradswdi <- raster("prad_sw_di.img") 
precwhal <- raster("prec_w_hal.img") 
precwinte <- raster("prec_winte.img") 
taveshal <- raster("tave_s_hal.img") 
tavesprin <- raster("tave_sprin.img") 
tmaxshal <- raster("tmax_s_hal.img") 
tmaxsumme <- raster("tmax_summe.img") 
rough1k <- raster("rough_1k.img") 
topos <- raster("topos.img") 
```

It looks like all CRS's of rasters are WGS84, so I won't have to re-project. Also all resolutions are the same, 0.0083 x 0.0083. n = 16

---

## Question #2

* Extract predictor variables from all 16 **`.img`** files using the presence:absence [X,Y]'s

```{r}

# layers <- c(etpt5, etpt6, etptsprin, exp1nrm, exp3nrm, exp5nrm, mindyrav, pradswdi, precwhal, precwinte, taveshal, tavesprin, tmaxshal, tmaxsumme, rough, topos)

# build the raster stack
  rangeDOM <- stack(layers) # create a raster stack
  rangeDOM # examine stack
```

```{r}
# extract from stack 
  t1 <- raster::extract(rangeDOM, pied.PPsA[, c("tr.wgs_x", "tr.wgs_y")])
vars <- sub(".img", "", colnames(t1))
colnames(t1) <- vars
head(t1, 2) 
```
This is causing issues-- there are NAs in predictors bc it's not punching out correctly.  Still not working, even after copying others' code and trying to re-download source files... How can this be??? 

---

## Question #3

* Create a new dataframe by binding the extracted predictor variable values to the dataframe from exercise #4.

```{r}
  rang.trTOPO <- cbind(pres.abs, t1_RANG) %>% # bind to train dataframe
    select(-c(wgs_xF, wgs_yF, x, y))

  head(rang.trTOPO, 2) # examine training data frame
  
```

I removed the wgs_xF and cell.wgs_x columns, since all coords are in tr.wgs_x. 

```{r}
ggplot(rang.trTOPO, aes(x=tr.wgs_x, y=tr.wgs_y)) +
  geom_point(aes(color=prec_winte.img)) +
  theme_classic()
```

A plot for fun, winter precipitation. Looks reasonable. 

```{r}
ggplot(rang.trTOPO, aes(x=tr.wgs_x, y=tr.wgs_y)) +
  geom_point(aes(color=rough_1k.img)) +
  theme_classic()
```

Assuming this is some kind of elevation layer? Looks like some of these predictors will be correlated. 

```{r}
ggplot(rang.trTOPO, aes(x=tr.wgs_x, y=tr.wgs_y)) +
  geom_point(aes(color=factor(RANG106))) +
  theme_classic()
```
Based on these maps, this species prefers higher-elevation sites. 

---

## Question #4

* Save your data as R objects:
  * Dataframe;
  * Point shapefile with geometry in R
  * Export as a point shapefile in ESRI format
* Save these R objects in a **`.RData`** file

These data will be used in the next exercise #6.

```{r}

# write out data files if desired
  setwd(path.mod2)
  write.csv(rang.trTOPO, file = "rang.trTOPO.csv", row.names = F) # save .csv - training data
  save(rang.trTOPO, file = "rang.trTOPO.RData") # save .RData - pres/abs plus stacked raster 
  save(pied.topoDOM, file = "pied.topoDOM.RData") # save .RData - stacked raster
  st_write(rang.trTOPO, dsn = ".", layer = "rang.trTOPO", driver = "ESRI Shapefile",
    delete_layer = T, delete_dsn = T) #point shapefile in ESRI format
```

---

## The End

---
