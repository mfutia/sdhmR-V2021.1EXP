---
title: "Exercise 7 Group A"
author: "Mia McReynolds, Eli Polzer, Matt Futia"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_knit$set(root.dir = "C:/Users/mttft/Desktop/UVM/UVM Courses/SDHM_R/sdhmR-V2021.1EXP")
knitr::opts_chunk$set(warning=FALSE,error=TRUE,message=FALSE)
```

---

## This exercise links to Module 5.1

Submit the completed exercise to us at:

* t.edwards@usu.edu 
* eric_tsakiris@fws.gov  

---

## Context

The data are of the *Pinus edulis* Common piñon, the species you dealt with in Exercise #3 -- #5.  This exercise relies on the dataframe you generated in exercise #6.  Hopefully you saved those combined presence:absence dataframe, with the reduced variables you begin SDHM model construction with, or regrettably you will need to return to exercise #6 and re--build that dataframe.

The goal is to:
* Estimate variables in reduced and full--variable logistic GLM models, significance, and direction of relationship
* Calculate an estimate of model fit
* Build a table of accuracy metrics, and AUC plot
* Provide some bulleted interpretation points
* Plot map products of the:
  * (i) probability; and 
  * (ii) classified distribution model
  * (Save these two maps as **`.img`** files for use later in the course)


Remember, you will have been assigned data for *edulis* having one the following four discrete labels:

* **Seedlings**:  these data indicate spatial locations where seedlings of the tree have been found
* **Mortality**: these data indicate spatial locations where mortality has been observed
* **Persistence**: these data have no observed mortality or seedling at given spatial locations
* **Range**: the total dataset, including all spatial locations of seedlings, mortality, and persistence

---

## The Data

* The dataframe completed in exercise #6.

---

## Question #1

* Import and explore data
  * **NOTE**:  intent is not to reduce number of variables; that was completed in exercise #5.  Rather, calculate simple descriptive statistics (mean, sd, n) and boxplots


```{r}
# Load packages
library(tidyverse)
library(data.table)
library(PresenceAbsence) # PresenceAbsence for accuracy metrics
library(DAAG)
library(raster)
library(sf)

# Set working directories
path.root <- "C:/Users/mttft/Desktop/UVM/UVM Courses/SDHM_R/sdhmR-V2021.1EXP"
path.mod2 <- paste(path.root, "/data/module02", sep = "")
path.figs <- paste(path.root, "/powerpoints/figures", sep = "") 
path.gis <- paste(path.root, "/data/gis_layers", sep = "")
path.range <- paste(path.root, "/data/RangeData", sep = "")

# Load CRSs
setwd(path.root)
source("r_code/prjs4_sdhmR.r")
ls(pattern = "prj.")

# Load presence:pseudo-absence and predictor data
load(paste(path.mod2, "/range_pres_psu_data.RData", sep = ""))
load(paste(path.mod2, "/tr_RANG.Rdata", sep = ""))
```

```{r}
vars = colnames(range_PPsA_ShortData[,18:33])

smmry <- range_PPsA_ShortData %>%
  group_by(RANG106) %>%
  summarise(AVE_etpt5 = mean(etpt_5), SD_etpt5 = sd(etpt_5),
            AVE_mind_yr_av = mean(mind_yr_av), SD_mind_yr_av = sd(mind_yr_av),
            AVE_prad_sw_di = mean(prad_sw_di), SD_prad_sw_di = sd(prad_sw_di),
            AVE_prec_w_hal = mean(prec_w_hal), SD_prec_w_hal = sd(prec_w_hal),
            AVE_rough_1k = mean(rough_1k), SD_rough_1k = sd(rough_1k),
            AVE_tmax_s_hal = mean(tmax_s_hal), SD_tmax_s_hal = sd(tmax_s_hal),
            AVE_topos = mean(topos), SD_topos = sd(topos))

smmry

ggplot(tr_RANG)+
  geom_boxplot(data = tr_RANG, aes(RANG106, tmax_s_hal))
ggplot(tr_RANG)+
  geom_boxplot(data = tr_RANG, aes(RANG106, mind_yr_av))
ggplot(tr_RANG)+
  geom_boxplot(data = tr_RANG, aes(RANG106, rough_1k))
```


---

## Question #2

* Construct full- and reduced-variable logistic GLM’s
* Determine an estimate of model fit, based on deviance.

**Full-variable logistic GLM**
```{r}
colnames(range_PPsA_ShortData[,18:33])
cn <- c(colnames(range_PPsA_ShortData[,1:17]) ,paste(names(range_PPsA_ShortData[,18:33]),".img", sep = ""))

colnames(range_PPsA_ShortData) <- cn

FullRange <- glm(RANG106 ~ etpt_5.img+etpt_6.img+etpt_sprin.img+exp1nrm.img+exp3nrm.img+exp5nrm.img+mind_yr_av.img+prad_sw_di.img+prec_w_hal.img+prec_winte.img+rough_1k.img+tave_s_hal.img+tave_sprin.img+tmax_s_hal.img+tmax_summe.img+topos.img, family = binomial, data = range_PPsA_ShortData)
summary(FullRange)

FullRange.fit <- 100 * (1 - FullRange$deviance/FullRange$null.deviance)
FullRange.fit
FullRange$deviance
FullRange.pred <- predict(FullRange, type = "response")
```
*Based on the deviance (`r FullRange$deviance`) for the full model and the D<sup>2</sup> (0.166), the fit of this model is poor.*

**Reduced-variable logistic GLM**
```{r}
PartRange <- glm(RANG106 ~ etpt_5+mind_yr_av+prad_sw_di+prec_w_hal+rough_1k+tmax_s_hal+topos, 
    family = binomial, data = tr_RANG)
summary(PartRange)

PartRange.fit <- 100 * (1 - PartRange$deviance/PartRange$null.deviance)
PartRange.fit
PartRange$deviance
PartRange.pred <- predict(PartRange, type = "response")
```
*Based on the deviance (`r PartRange$deviance`) for the reduced model and the D<sup>2</sup> (0.128), the fit of this model is also poor.*

---

## Question #3

* Calculate accuracy metrics (as in Module 3.2 and 3.3, Analytical Intermission) using:
  * Resubstitution approaches, and
  * A 10-fold cross--validation approach

**Accuracy with Resubstitution**
```{r}
modl <- "mod2.LR"
dat2 <- cbind(modl, tr_RANG[2], PartRange.pred)
head(dat2, 2)

mod.cut <- optimal.thresholds(dat2, opt.methods = c("Default"))
mod.cut

# generate confusion matrix
PartRange.cfmat <- table(dat2[[2]], factor(as.numeric(dat2$PartRange.pred >= mod.cut$PartRange.pred)))
PartRange.cfmat

# calculate model accuracies with standard deviation=F
PartRange.acc <- presence.absence.accuracy(dat2, threshold = mod.cut$PartRange.pred, st.dev = F)
tss <- PartRange.acc$sensitivity + PartRange.acc$specificity - 1
PartRange.acc <- cbind(PartRange.acc[1:7], tss)
PartRange.acc[c(1, 4:5, 7:8)]

auc.roc.plot(dat2, color = T)
```

**Accuracy with 10-fold Cross Validation**
```{r}
set.seed(1234)
PartRange.cv <- CVbinary(PartRange, nfolds = 10, print.details = F)
PartRange.cv <- PartRange.cv$cvhat
dat2 <- cbind(dat2[,1:2], PartRange.cv)
head(dat2)

# generate confusion matrix
PartRange.cfmatJ <- table(dat2[[2]], factor(as.numeric(dat2$PartRange.cv >= mod.cut$PartRange.pred)))
PartRange.cfmatJ

# calculate model accuracy with standard deviation=F
PartRange.accB <- presence.absence.accuracy(dat2, threshold = mod.cut$PartRange.pred, st.dev = F)
tss <- PartRange.accB$sensitivity + PartRange.accB$specificity - 1
PartRange.accB <- cbind(PartRange.accB[1:7], tss)
PartRange.accB[c(1, 4:5, 7:8)]
```
*Two methods produced similar accuracy results*
---

## Question #4

* Build 2 prediction maps:
  * A raw probability estimate for each cell in the modelling domain; and
  * A classified map based on the selected threshold from Question #3

**Raw Probability Estimate**
```{r}
setwd(path.mod2)
load("rangeDOM.RData") 
rang.probLR <- predict(rangeDOM,FullRange,filename="FullRange.probLR.img",type="response",fun=predict,index=2, overwrite=TRUE)
rang.probLR

setwd(path.gis)
states <- st_read(dsn = ".", layer = "na_states_wgs")

plot(rang.probLR, legend = T, axes = T, main = "Probability Map")
plot(st_geometry(states), add = T, lwd = 1.5)
```

**Classified Map**
```{r classified map data}
rang.clasLR <- reclassify(rang.probLR, filename = "range.clas.LR.img", 
   (c(0, mod.cut[[2]], 0, mod.cut[[2]], 1, 1)), overwrite=TRUE)

plot(rang.clasLR, legend = T, axes = T, main = "Classification Map")
plot(st_geometry(states), add = T, lwd = 1.5)
```

---

## Question #5

* Save your data as R objects:
  * Accuracy metrics as a dataframe;
  * Classification threshold as a stand--alone scalar
  * Both prediction maps as **`.img`** format
* Save these R objects in a **`.RData`** file

These data will be used again in Module 10, Ensemble Models.

```{r}
setwd(path.range)

# Accuracy metrics as a dataframe
all.acc_Reduced <- rbind(PartRange.acc, PartRange.accB)

# Classification threshold as a stand--alone scalar
mod.cut_50 <- mod.cut[[2]]

#plots saved this manually

save(FullRange, PartRange, all.acc_Reduced, mod.cut_50, file = "C:/Users/mttft/Desktop/UVM/UVM Courses/SDHM_R/sdhmR-V2021.1EXP/data/RangeData/GLM_Results.Rdata")
```

---

## The End

---
