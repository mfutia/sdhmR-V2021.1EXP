---
title: "Exercise 4: Creating Pseudo-absences"
author: "Group A: Eli Polzer, Matt Futia, Mia McReynolds"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

Updated-- I used the code exactly from the HW 4 we turned in. 

```{r global_options, include=FALSE}
knitr::opts_knit$set(root.dir = "~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1")
#knitr::opts_knit$set(root.dir = "~/sdhmR-V2020.2")
knitr::opts_chunk$set(warning=FALSE,error=TRUE,message=FALSE)
```

```{r}
#filepaths
  path.root <- "~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1" 
  path.mod2 <- paste(path.root, "/data/module02", sep = "")
  path.figs <- paste(path.root, "/powerpoints/figures", sep = "") 
  path.gis <- paste(path.root, "/data/gis_layers", sep = "")
  path.dat <- paste(path.root, "/sdhmR-V2021.1EXP/Data/exercise/traindat", sep = "")
  
prj.wgs84 <- "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs" # epsg:4326
```

```{r}
# some libraries
  library(raster)	# FXNS: extent, raster, res, rasterize, values, writeRaster, 
					#       cellFromXY, extract
  library(sf)    	# FXNS: st_as_sf, st_as_sfc, st_bbox, st_convex_hull, st_union
					#       st_buffer, st_read, st_write, st_intersection, st_geometry,
					#       st_drop_geometry, st_coordinates, st_sf
```

---

## Question #1

* Import the data type you have been assigned to work with
* Build a buffered-presence points bounding box
  * Buffer each point by ~50km 
  * **CAUTION**:  make sure the pluses and minuses when buffering are in the correct direction given north, south, east, and west !! (Serious screw-ups happen here …)
* Ensure you assign correct CRS, values, and resolution to bounding box


```{r}
tru.range <- read.csv("~/University of Vermont/Classes/sdhmR/sdhmR-V2021.1/data/exercise/traindat/spp106pr_RANG_2.csv")
dim(tru.range)
```

```{r}
head(tru.range,2)
```

```{r}
pied.range <- st_as_sf(tru.range, coords = c("wgs_xF", "wgs_yF"), 
                      crs = prj.wgs84, remove = F) 
head(pied.range, 2)
```

```{r}
class(pied.range)
```

```{r}
extb <- extent(min(tru.range$wgs_xF) - 0.5, max(tru.range$wgs_xF) + 0.5, 
               min(tru.range$wgs_yF) - 0.5, max(tru.range$wgs_yF) + 0.5)
pied.range.bufSF <- st_as_sfc(st_bbox(extb, crs = prj.wgs84))
pied.range.bufSF
```

```{r}
setwd(path.gis)
t1 <- raster("templateR_wgs.img")
```

```{r}
t1
```

```{r}
pied.range.bufSP <- as_Spatial(pied.range.bufSF) 
pied.range.bufR <- crop(rasterize(pied.range.bufSP, t1), pied.range.bufSP)
pied.range.bufR
```

```{r}
# plot(t1, legend = F, col = "grey90")
# plot(pied.range.bufR, add = T, col = "grey30", legend = F)
# plot(pied.range.bufSF, add = T, border = "darkgreen", lwd = 2)
```

```{r}
plot(pied.range.bufSF, col = "gray90", axes = T, 
     main = "Buffered bounding box on presence points")
points(tru.range$wgs_xF, tru.range$wgs_yF, pch = 20, col = "darkgreen")  
```


---

## Question #2

* Build a fishnet for the bounding box
```{r}
f1 <- sp::coordinates(pied.range.bufR) 
f2 <- cellFromXY(pied.range.bufR, f1) 
f3 <- as.data.frame(cbind(f1, f2)) 
head(f3, 2) 
```

```{r}
tail(f3, 2) 
```

```{r}
ncell(pied.range.bufR)
```

```{r}
names(f3)[1:3] <- c("cell.wgs_x", "cell.wgs_y", "FNETID")
f3 <- f3[c("FNETID", "cell.wgs_x", "cell.wgs_y")] 

pied.range.fnetSF <- st_as_sf(f3, coords = c("cell.wgs_x", "cell.wgs_y"), 
                           crs = prj.wgs84, remove = F) 
head(pied.range.fnetSF, 2)
```

```{r}
class(pied.range.fnetSF) 
```

```{r}
pied.range.fnetDF <- st_drop_geometry(pied.range.fnetSF)
head(pied.range.fnetDF, 2)
```

```{r}
tail(pied.range.fnetDF, 2)
```

```{r}
class(pied.range.fnetDF)
```


---

## Question #3

* Use the fishnet to create a pseudo--absence data frame of [X,Y]’s
* For simplicity’s sake, set $n$ for pseudo--absence at twice (2$\times$) the number of presences in your respective RANG, PERS, MORT, and SEED data set
* Bind these data to the presence dataframe you imported in Question #1 (spp106pr_RANG)
```{r}
setwd(path.mod2)
load("pied.framesR.RData")
pied.range.bufR
```

```{r}
setwd(path.mod2)
load("pied.framesSF.RData")
pied.range.bufSF
```

```{r}
load("pied.range.fnet.RData")
head(pied.range.fnetDF , 2)
```

```{r}
head(pied.range.fnetSF , 2)
```

```{r}
tru.xy <- tru.range[c("wgs_xF", "wgs_yF")]
pX <- sp::coordinates(tru.xy) 
pres.fnetid <- cellFromXY(pied.range.bufR, pX)
tru.rangeFNET <- cbind(pres.fnetid, tru.range)
names(tru.rangeFNET)[1] <- "FNETID"
head(tru.rangeFNET, 2)
```

```{r}
plot(pied.range.bufR, col = "gray70", legend = F, main = "Points in modelling frame")
points(tru.range$wgs_xF, tru.range$wgs_yF, pch = 20, col = "darkgreen") 
```

```{r}
buf.fnetid <- extract(pied.range.bufR, pied.range.fnetDF[c("cell.wgs_x", "cell.wgs_y")])
tru.bufFNET <- cbind(pied.range.fnetDF, buf.fnetid) 
head(tru.bufFNET, 2)
```

```{r}
plot(pied.range.bufR, col = "gray90", legend = F, main = "Modelling frame on FISHNET")
plot(pied.range.bufR, col = "gray50", legend = F, add = T)
```

```{r}
plot(pied.range.bufR, col = "gray90", legend = F, 
     main = "SP locations nested in modelling frame in FISHNET")
plot(pied.range.bufR, col = "gray50", legend = F, add = T)
points(tru.range$wgs_xF, tru.range$wgs_yF, pch = 20, col = "darkgreen")
```

```{r}
m1 <- merge(pied.range.fnetDF, tru.bufFNET, by = c("FNETID", "cell.wgs_x", "cell.wgs_y"), all.y = T)
head(m1, 2)
```

```{r}
pied.indexFNET <- merge(m1, tru.rangeFNET, by = c("FNETID"), all = T) 
head(pied.indexFNET, 2)
```

```{r}
names(pied.indexFNET)[4] <- "in.modFR"

# setwd(path.mod2)
# p1 <- get(load("pied.indexFNET_MASTER.RData")) --> This is redundant, I think? Making my code fail, just renamed this

p1 <- pied.indexFNET
head(p1, 2)
```

```{r}
p2.spp <- subset(p1$FNETID, p1$RANG106 == 1)
p2.modFR <- subset(p1$FNETID, p1$in.modFR == 1)
length(p2.spp) #back on track!
```

```{r}
length(p2.modFR)
```

```{r}
p3 <- p1[!p1$FNETID %in% p2.spp, ]
p4 <- p1[!p1$FNETID %in% p2.spp & p1$FNETID %in% p2.modFR, ]
psu.buf <- p4

set.seed(1234) 
psu.srs2 <- psu.buf[sample(1:nrow(psu.buf), 2 * table(p1$RANG106)[[1]], replace = F), ]
psu.srs2$RANG106 <- 0  
psu.srs2$in.modFR <- 1 
dim(psu.srs2) 
```

```{r}
head(psu.srs2, 2)
```

```{r}
head(tru.rangeFNET, 2)
```

```{r}
head(psu.srs2, 2)
```

```{r}
pied.PPsA <- merge(tru.rangeFNET, psu.srs2, by = c("FNETID", "RANG106", "wgs_xF", "wgs_yF"), all = T)
pied.PPsA$in.modFR <- NULL

pied.PPsA$tr.wgs_x <- ifelse(pied.PPsA$RANG106 == 0, pied.PPsA$cell.wgs_x, pied.PPsA$wgs_xF)
pied.PPsA$tr.wgs_y <- ifelse(pied.PPsA$RANG106 == 0, pied.PPsA$cell.wgs_y, pied.PPsA$wgs_yF)
```


---

## Question #4

* Save your data as R objects, including both the true presence and pseudo-absences:
  * Dataframe;
  * Point shapefile with geometry in R
  * Export as a point shapefile in ESRI format
* Save these R objects in a **`.RData`** file
* Save the bounding box as a raster--based **`.img`** file


```{r}
setwd(path.mod2)
save("pied.range.bufR", file = "pied.framesR.RData")
save("pied.range.bufSF", file = "pied.framesSF.RData")
save("pied.range.bufSP", file = "pied.framesSP.RData")

setwd(path.mod2)
st_write(pied.range.fnetSF, dsn = ".", layer = "piedrange_fnetSF", driver = "ESRI Shapefile",
         delete_layer = T, delete_dsn = T)

```

```{r}
setwd(path.mod2)
save("pied.range.fnetSF", "pied.range.fnetDF", file = "pied.range.fnet.RData")
save(pied.indexFNET, file = "pied.indexFNET.RData")
write.csv(pied.PPsA, file = "pied_PPsA.csv", row.names = F)
save(pied.PPsA, file = "pied.PPsA.RData")
```

---

## The End

---
