---
title: "Exercise 4 Group A"
author: "Mia McReynolds, Eli Polzer, Matt Futia"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_knit$set(root.dir = getwd())
knitr::opts_chunk$set(warning=FALSE,error=TRUE,message=FALSE)
```

---

## Question #1

* Import the data type you have been assigned to work with
* Build a buffered-presence points bounding box
  * Buffer each point by ~50km 
  * **CAUTION**:  make sure the pluses and minuses when buffering are in the correct direction given north, south, east, and west !! (Serious screw-ups happen here …)
* Ensure you assign correct CRS, values, and resolution to bounding box

```{r}
# Load packages, working directories, and range dataset
library(ggplot2)
library(sf)
library(raster)
path.root = "C:/Users/mttft/Desktop/UVM/UVM Courses/SDHM_R/sdhmR-V2021.1EXP"
path.mod2 = paste(path.root, "/data/module02", sep = "")
path.figs = paste(path.root, "/powerpoints/figures", sep = "") 
path.gis = paste(path.root, "/data/gis_layers", sep = "")

range = read.csv(paste(path.root, "/data/exercise/traindat/spp106pr_RANG.csv", sep = ""))
```

```{r}
# Create buffered-presence points bounding box with ~50km buffer
prj.wgs84 = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs"

extb = extent(min(range$wgs_xF) - 0.5, max(range$wgs_xF) + 0.5, 
                 min(range$wgs_yF) - 0.5, max(range$wgs_yF) + 0.5)
range.bufSF = st_as_sfc(st_bbox(extb, crs = prj.wgs84))
range.bufSF
plot(st_geometry(range.bufSF), axes = T)
```

```{r}
#Create point-based buffered bounding box
range.pres <- st_as_sf(range, coords = c("wgs_xF", "wgs_yF"), crs = prj.wgs84, remove = F)
range.bufptSF <- st_buffer(range.pres, dist = .5)
range.bufptSF <- st_union(range.bufptSF)
```


```{r}
# Set CRS and create raster file
setwd(path.gis)
t1 = raster("templateR_wgs.img")
range.bufSP = as_Spatial(range.bufSF)
range.bufR = crop(rasterize(range.bufSP, t1), range.bufSP) 
range.bufR 

range.bufptSP = as_Spatial(range.bufptSF)
range.bufptR = crop(rasterize(range.bufptSP, t1), range.bufptSP)

ggplot()+
  geom_sf(data = range.bufSF, fill = "gray95")+
  geom_sf(data = range.bufptSF, fill = "gray80")+
#  geom_raster(data = t1)+
  geom_point(data = range, aes(wgs_xF, wgs_yF), shape = 1, color = "darkgreen")+
  theme_classic()
```

---

## Question #2

* Build a fishnet for the bounding box

```{r}
# Build fishnet from rastered bounding box
f1 = sp::coordinates(range.bufR)
f2 = cellFromXY(range.bufR, f1)
f3 = as.data.frame(cbind(f1, f2))

names(f3)[1:3] = c("cell.wgs_x", "cell.wgs_y", "FNETID")
f3 = f3[c("FNETID", "cell.wgs_x", "cell.wgs_y")]

range.fnetSF = st_as_sf(f3, coords = c("cell.wgs_x", "cell.wgs_y"), crs = prj.wgs84, remove = F)
range.fnetDF = st_drop_geometry(range.fnetSF)
```

---

## Question #3

* Use the fishnet to create a pseudo--absence data frame of [X,Y]’s
* For simplicity’s sake, set $n$ for pseudo--absence at twice (2$\times$) the number of presences in your respective RANG, PERS, MORT, and SEED data set
* Bind these data to the presence dataframe you imported in Question #1

```{r}
tru.xy = range[c("wgs_xF", "wgs_yF")]
p1 = sp::coordinates(tru.xy)
pres.fnetid <- cellFromXY(range.bufptR, p1)
length(pres.fnetid)
length(range$RANG106)

tru.presFNET = cbind(pres.fnetid, range)
names(tru.presFNET)[1] = "FNETID"
```

```{r}
bufpt.fnetid = raster::extract(range.bufptR, range.fnetDF[c("cell.wgs_x", "cell.wgs_y")])
tru.bufptFNET = cbind(range.fnetDF, bufpt.fnetid)

length(tru.bufptFNET$bufpt.fnetid)               # 2246560
ncell(range.bufR)                                # 2246560
table(tru.bufptFNET$bufpt.fnetid)[[1]]           # 1095407
length(which(is.na(tru.bufptFNET$bufpt.fnetid))) # 1151153

plot(range.bufR, col = "gray95", legend = F)
plot(range.bufptR, col = "gray80", legend = F, add = T)
points(range$wgs_xF, range$wgs_yF, pch = 20, col = "darkgreen")
```

```{r}
# Create index data frame
m1 <- merge(range.fnetDF, tru.bufptFNET, by = c("FNETID", "cell.wgs_x", "cell.wgs_y"), all.y = T)
range.indexFNET <- merge(m1, tru.presFNET, by = c("FNETID"), all = T)
names(range.indexFNET)[4] <- "in.modFR"

setwd(path.mod2)
saveRDS(range.indexFNET, file = "range.indexFNET.rds")
```

```{r}
#Extract pseudo-absences with 2 multiplier
p1 = range.indexFNET
p2.spp <- subset(p1$FNETID, p1$RANG106 == 1)
p2.modFR <- subset(p1$FNETID, p1$in.modFR == 1)
length(p2.spp)   #1999
length(p2.modFR) #1095407

p3 <- p1[!p1$FNETID %in% p2.spp, ]
p4 <- p1[!p1$FNETID %in% p2.spp & p1$FNETID %in% p2.modFR, ]
psu.bufpt <- p4

set.seed(1234)
psu.srs1 <- psu.bufpt[sample(1:nrow(psu.bufpt), 2*table(p1$RANG106)[[1]], replace = F), ]
psu.srs1$RANG106 <- 0
psu.srs1$in.modFR <- 1
dim(psu.srs1)   #3998

range.PPsA <- merge(tru.presFNET, psu.srs1, by = c("FNETID", "RANG106", "wgs_xF", "wgs_yF"), all = T)
range.PPsA$in.modFR <- NULL
dim(range.PPsA)  #5997

range.PPsA$tr.wgs_x <- ifelse(range.PPsA$RANG106 == 0, range.PPsA$cell.wgs_x, range.PPsA$wgs_xF)
range.PPsA$tr.wgs_y <- ifelse(range.PPsA$RANG106 == 0, range.PPsA$cell.wgs_y, range.PPsA$wgs_yF)
head(range.PPsA,2)
```

---

## Question #4

* Save your data as R objects, including both the true presence and pseudo-absences:
  * Dataframe;
  * Point shapefile with geometry in R
  * Export as a point shapefile in ESRI format
* Save these R objects in a **`.RData`** file
* Save the bounding box as a raster--based **`.img`** file

```{r}
setwd(path.mod2)
save("range.PPsA", "p2.spp", "p2.modFR", "psu.bufpt", "range.bufptR", "range.bufR", file = "range_pres.psu.RData")
st_write(range.bufptSF, dsn = ".", layer = "range.fnetSF", driver = "ESRI Shapefile",
    delete_layer = T, delete_dsn = T)
writeRaster(range.bufptR, "RangeBufPt", format = "HFA", overwrite = T)
writeRaster(range.bufR, "RangeBuf", format = "HFA")
```

---

## The End

---
